name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: true

jobs:
  build-release:
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: ssd_sn_tool
            asset_name: ssd_sn_tool-windows-x86_64.exe
            upx_asset_name: ssd_sn_tool-windows-x86_64-upx.exe
          - os: ubuntu-latest
            artifact_name: ssd_sn_tool
            asset_name: ssd_sn_tool-linux-x86_64
            upx_asset_name: ssd_sn_tool-linux-x86_64-upx

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build release binary
      run: cargo build --release --verbose

    - name: Strip binary (Linux only)
      if: matrix.os == 'ubuntu-latest'
      run: strip target/release/${{ matrix.artifact_name }}

    - name: Install UPX (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.zip" -OutFile "upx.zip"
        Expand-Archive -Path "upx.zip" -DestinationPath "upx-temp"
        Move-Item -Path "upx-temp/upx-4.2.4-win64/upx.exe" -Destination "upx.exe"

    - name: Install UPX (Linux)
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        curl -L -o upx.tar.xz https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-amd64_linux.tar.xz
        tar -xf upx.tar.xz
        mv upx-4.2.4-amd64_linux/upx /usr/local/bin/
        chmod +x /usr/local/bin/upx

    - name: Compress binary with UPX (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        .\upx.exe --best --ultra-brute "target/release/${{ matrix.artifact_name }}.exe" -o "${{ matrix.upx_asset_name }}"
        Copy-Item "target/release/${{ matrix.artifact_name }}.exe" -Destination "${{ matrix.asset_name }}"

    - name: Compress binary with UPX (Linux)
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        upx --best --ultra-brute "target/release/${{ matrix.artifact_name }}" -o "${{ matrix.upx_asset_name }}"
        cp "target/release/${{ matrix.artifact_name }}" "${{ matrix.asset_name }}"
        chmod +x "${{ matrix.asset_name }}"
        chmod +x "${{ matrix.upx_asset_name }}"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os }}-binaries
        path: |
          ${{ matrix.asset_name }}
          ${{ matrix.upx_asset_name }}
        retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: build-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## 下载\n\n### Windows\n- **ssd_sn_tool-windows-x86_64-upx.exe** - UPX压缩版 (推荐)\n- ssd_sn_tool-windows-x86_64.exe - 原始版本\n\n### Linux\n- **ssd_sn_tool-linux-x86_64-upx** - UPX压缩版 (推荐)\n- ssd_sn_tool-linux-x86_64 - 原始版本\n\n## 使用说明\n\n### 图形界面模式\n直接运行可执行文件即可打开图形界面。\n\n### 命令行模式\n```bash\n# 生成固件版本号\n./ssd_sn_tool firmware generate 2025 12 1 1 1024 A 4\n\n# 解析固件版本号\n./ssd_sn_tool firmware parse S01E1A4\n\n# 查看配置\n./ssd_sn_tool firmware config\n```
        draft: false
        prerelease: false

    - name: Upload Windows UPX Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: artifacts/windows-latest-binaries/ssd_sn_tool-windows-x86_64-upx.exe
        asset_name: ssd_sn_tool-windows-x86_64-upx.exe
        asset_content_type: application/octet-stream

    - name: Upload Windows Original Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: artifacts/windows-latest-binaries/ssd_sn_tool-windows-x86_64.exe
        asset_name: ssd_sn_tool-windows-x86_64.exe
        asset_content_type: application/octet-stream

    - name: Upload Linux UPX Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: artifacts/ubuntu-latest-binaries/ssd_sn_tool-linux-x86_64-upx
        asset_name: ssd_sn_tool-linux-x86_64-upx
        asset_content_type: application/octet-stream

    - name: Upload Linux Original Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: artifacts/ubuntu-latest-binaries/ssd_sn_tool-linux-x86_64
        asset_name: ssd_sn_tool-linux-x86_64
        asset_content_type: application/octet-stream
