name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  RUST_BACKTRACE: 1

jobs:
  build-release:
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: ssd_sn_tool
            asset_name: ssd_sn_tool-windows-x86_64.exe
            upx_asset_name: ssd_sn_tool-windows-x86_64-upx.exe
          - os: ubuntu-latest
            artifact_name: ssd_sn_tool
            asset_name: ssd_sn_tool-linux-x86_64
            upx_asset_name: ssd_sn_tool-linux-x86_64-upx

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build release binary
      run: cargo build --release --verbose

    - name: Strip binary (Linux only)
      if: matrix.os == 'ubuntu-latest'
      run: strip target/release/${{ matrix.artifact_name }}

    - name: Display binary size before UPX
      run: |
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          ls -lh "target/release/${{ matrix.artifact_name }}.exe"
        else
          ls -lh "target/release/${{ matrix.artifact_name }}"
        fi

    - name: Install UPX
      run: |
        if [ "${{ runner.os }}" == "Windows" ]; then
          # Windows - ä½¿ç”¨ PowerShell è§£å‹
          curl -L -o upx.zip https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.zip
          powershell -Command "Expand-Archive -Path upx.zip -DestinationPath upx-temp"
          mv upx-temp/upx-4.2.4-win64/upx.exe /usr/local/bin/
        else
          # Linux
          curl -L -o upx.tar.xz https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-amd64_linux.tar.xz
          tar -xf upx.tar.xz
          mv upx-4.2.4-amd64_linux/upx /usr/local/bin/
        fi
        chmod +x /usr/local/bin/upx

    - name: Compress binary with UPX
      id: upx
      run: |
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          upx --best --ultra-brute "target/release/${{ matrix.artifact_name }}.exe" -o "${{ matrix.upx_asset_name }}"
          cp "target/release/${{ matrix.artifact_name }}.exe" "${{ matrix.asset_name }}"
        else
          upx --best --ultra-brute "target/release/${{ matrix.artifact_name }}" -o "${{ matrix.upx_asset_name }}"
          cp "target/release/${{ matrix.artifact_name }}" "${{ matrix.asset_name }}"
          chmod +x "${{ matrix.asset_name }}"
          chmod +x "${{ matrix.upx_asset_name }}"
        fi

    - name: Display binary sizes after UPX
      run: |
        echo "Original binary size:"
        ls -lh "${{ matrix.asset_name }}"
        echo "UPX compressed binary size:"
        ls -lh "${{ matrix.upx_asset_name }}"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os }}-binaries
        path: |
          ${{ matrix.asset_name }}
          ${{ matrix.upx_asset_name }}
        retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: build-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure of downloaded files
      run: |
        find artifacts -type f -name "*.exe" -o -name "ssd_sn_tool*" | sort
        echo "=== File sizes ==="
        find artifacts -type f -name "*.exe" -o -name "ssd_sn_tool*" -exec ls -lh {} \;

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false
        body: |
          # SSD SNç å·¥å…· ${{ github.ref_name }}

          ## ğŸš€ åŠŸèƒ½ç‰¹ç‚¹
          - å›ºä»¶ç‰ˆæœ¬å·ç”Ÿæˆå’Œè§£æ
          - å›¾å½¢ç•Œé¢å’Œå‘½ä»¤è¡Œæ”¯æŒ
          - è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€Linuxï¼‰
          - å•æ–‡ä»¶éƒ¨ç½²ï¼Œæ— éœ€é¢å¤–ä¾èµ–

          ## ğŸ“¦ ä¸‹è½½

          ### Windows
          - **[ssd_sn_tool-windows-x86_64-upx.exe](ssd_sn_tool-windows-x86_64-upx.exe)** - UPXå‹ç¼©ç‰ˆ (æ¨è)
          - [ssd_sn_tool-windows-x86_64.exe](ssd_sn_tool-windows-x86_64.exe) - åŸå§‹ç‰ˆæœ¬

          ### Linux
          - **[ssd_sn_tool-linux-x86_64-upx](ssd_sn_tool-linux-x86_64-upx)** - UPXå‹ç¼©ç‰ˆ (æ¨è)
          - [ssd_sn_tool-linux-x86_64](ssd_sn_tool-linux-x86_64) - åŸå§‹ç‰ˆæœ¬

          ## ğŸ”§ ä½¿ç”¨è¯´æ˜

          ### å›¾å½¢ç•Œé¢æ¨¡å¼
          ç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶å³å¯æ‰“å¼€å›¾å½¢ç•Œé¢ã€‚

          ### å‘½ä»¤è¡Œæ¨¡å¼
          ```bash
          # ç”Ÿæˆå›ºä»¶ç‰ˆæœ¬å·
          ./ssd_sn_tool firmware generate 2025 12 1 1 1024 A 4

          # è§£æå›ºä»¶ç‰ˆæœ¬å·
          ./ssd_sn_tool firmware parse S01E1A4

          # æŸ¥çœ‹é…ç½®
          ./ssd_sn_tool firmware config
          ```

          ## ğŸ“Š æ–‡ä»¶ä¿¡æ¯
          æ„å»ºæ—¶é—´: ${{ fromJSON(steps.create_release.outputs.upload_url).created_at }}

          ---
          *è‡ªåŠ¨ç”Ÿæˆäº GitHub Actions*
        files: |
          artifacts/windows-latest-binaries/ssd_sn_tool-windows-x86_64-upx.exe
          artifacts/windows-latest-binaries/ssd_sn_tool-windows-x86_64.exe
          artifacts/ubuntu-latest-binaries/ssd_sn_tool-linux-x86_64-upx
          artifacts/ubuntu-latest-binaries/ssd_sn_tool-linux-x86_64
